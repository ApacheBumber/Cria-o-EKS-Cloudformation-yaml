AWSTemplateFormatVersion: '2010-09-09'
Description: Template para criação de 6 policies IAM

Parameters:
  ClusterName:
    Type: String
    Description: Nome do cluster usado para prefixo das policies
    
Resources:
  Policy1:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub "${ClusterName}-AmazonEKSAdminPolicy"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "eks:*"
              - "eks:DescribeNodegroup"
              - "eks:ListNodegroups"
              - "eks:DescribeCluster"
              - "eks:ListClusters"
              - "eks:AccessKubernetesApi"
              - "ssm:GetParameter"
              - "eks:ListUpdates"
              - "eks:ListFargateProfiles"
              - "eks:UpdateClusterVersion"
              - "ec2:DescribeAccountAttributes"
            Resource: "*"

  Policy2:
    Type: AWS::IAM::ManagedPolicy
    DependsOn: Policy1
    Properties:
      ManagedPolicyName: !Sub "${ClusterName}-eks-admin-policy"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "eks:*"
            Resource: "*"

  Policy3:
    Type: AWS::IAM::ManagedPolicy
    DependsOn: Policy2
    Properties:
      ManagedPolicyName: !Sub "${ClusterName}-KUBERNETES-NODES-WAFv2"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "acm:DescribeCertificate"
              - "acm:ListCertificates"
              - "acm:GetCertificate"
            Resource: "*"
          - Effect: Allow
            Action:
              - "ec2:AuthorizeSecurityGroupIngress"
              - "ec2:CreateSecurityGroup"
              - "ec2:CreateTags"
              - "ec2:DeleteTags"
              - "ec2:DeleteSecurityGroup"
              - "ec2:DescribeAccountAttributes"
              - "ec2:DescribeAddresses"
              - "ec2:DescribeInstances"
              - "ec2:DescribeInstanceStatus"
              - "ec2:DescribeInternetGateways"
              - "ec2:DescribeNetworkInterfaces"
              - "ec2:DescribeSecurityGroups"
              - "ec2:DescribeSubnets"
              - "ec2:DescribeTags"
              - "ec2:DescribeVpcs"
              - "ec2:ModifyInstanceAttribute"
              - "ec2:ModifyNetworkInterfaceAttribute"
              - "ec2:RevokeSecurityGroupIngress"
            Resource: "*"
          - Effect: Allow
            Action:
              - "elasticloadbalancing:AddListenerCertificates"
              - "elasticloadbalancing:AddTags"
              - "elasticloadbalancing:CreateListener"
              - "elasticloadbalancing:CreateLoadBalancer"
              - "elasticloadbalancing:CreateRule"
              - "elasticloadbalancing:CreateTargetGroup"
              - "elasticloadbalancing:DeleteListener"
              - "elasticloadbalancing:DeleteLoadBalancer"
              - "elasticloadbalancing:DeleteRule"
              - "elasticloadbalancing:DeleteTargetGroup"
              - "elasticloadbalancing:DeregisterTargets"
              - "elasticloadbalancing:DescribeListenerCertificates"
              - "elasticloadbalancing:DescribeListeners"
              - "elasticloadbalancing:DescribeLoadBalancers"
              - "elasticloadbalancing:DescribeLoadBalancerAttributes"
              - "elasticloadbalancing:DescribeRules"
              - "elasticloadbalancing:DescribeSSLPolicies"
              - "elasticloadbalancing:DescribeTags"
              - "elasticloadbalancing:DescribeTargetGroups"
              - "elasticloadbalancing:DescribeTargetGroupAttributes"
              - "elasticloadbalancing:DescribeTargetHealth"
              - "elasticloadbalancing:ModifyListener"
              - "elasticloadbalancing:ModifyLoadBalancerAttributes"
              - "elasticloadbalancing:ModifyRule"
              - "elasticloadbalancing:ModifyTargetGroup"
              - "elasticloadbalancing:ModifyTargetGroupAttributes"
              - "elasticloadbalancing:RegisterTargets"
              - "elasticloadbalancing:RemoveListenerCertificates"
              - "elasticloadbalancing:RemoveTags"
              - "elasticloadbalancing:SetIpAddressType"
              - "elasticloadbalancing:SetSecurityGroups"
              - "elasticloadbalancing:SetSubnets"
              - "elasticloadbalancing:SetWebACL"
            Resource: "*"
          - Effect: Allow
            Action:
              - "iam:CreateServiceLinkedRole"
              - "iam:GetServerCertificate"
              - "iam:ListServerCertificates"
            Resource: "*"
          - Effect: Allow
            Action:
                - "cognito-idp:DescribeUserPoolClient"
            Resource: "*"
          - Effect: Allow
            Action:
              - "waf-regional:GetWebACLForResource"
              - "waf-regional:GetWebACL"
              - "waf-regional:AssociateWebACL"
            Resource: "*"
          - Effect: Allow
            Action:
              - "tag:GetResources"
              - "tag:TagResources"
            Resource: "*"
          - Effect: Allow
            Action:
              - "waf:GetWebACL"
            Resource: "*"
          - Effect: Allow
            Action:
              - "wafv2:GetWebACL"
              - "wafv2:GetWebACLForResource"
              - "wafv2:AssociateWebACL"
              - "wafv2:DisassociateWebACL"
            Resource: "*"
          - Effect: Allow
            Action:
              - "shield:DescribeProtection"
              - "shield:GetSubscriptionState"
              - "shield:DeleteProtection"
              - "shield:CreateProtection"
              - "shield:DescribeSubscription"
              - "shield:ListProtections"
            Resource: "*"

  Policy4:
    Type: AWS::IAM::ManagedPolicy
    DependsOn: Policy3
    Properties:
      ManagedPolicyName: !Sub "${ClusterName}-KUBERNETES-NODES-S3"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: "VisualEditor0"
            Effect: Allow
            Action:
              - "s3:PutObject"
              - "s3:GetObject"
              - "s3:ListBucket"
              - "s3:DeleteObject"
            Resource: "*"

  Policy5:
    Type: AWS::IAM::ManagedPolicy
    DependsOn: Policy4
    Properties:
      ManagedPolicyName: !Sub "${ClusterName}-KUBERNETES-REKOGNITION-COGNITO"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: "VisualEditor0"
            Effect: Allow
            Action:
              - "cognito-identity:*"
              - "cognito-idp:*"
              - "cognito-sync:*"
              - "rekognition:*"
            Resource: "*"

  Policy6:
    Type: AWS::IAM::ManagedPolicy
    DependsOn: Policy5
    Properties:
      ManagedPolicyName: !Sub "${ClusterName}-SQS-SSM-SES-KMS-DYNAMO-SNS-SECRETS"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: "rule1"
            Effect: Allow
            Action:
              - "sqs:*"
              - "ssm:*"
              - "ses:*"
              - "kms:*"
              - "sns:Publish"
              - "sns:SetEndpointAttributes"
              - "sns:SetSubscriptionAttributes"
              - "sns:SetSMSAttributes"
              - "sns:SetPlatformApplicationAttributes"
              - "sns:SetTopicAttributes"
              - "secretsmanager:GetRandomPassword"
              - "secretsmanager:GetResourcePolicy"
              - "secretsmanager:GetSecretValue"
              - "secretsmanager:DescribeSecret"
              - "secretsmanager:ListSecrets"
              - "secretsmanager:ListSecretVersionIds"
            Resource: "*"

Outputs:
  Policy1Arn:
    Description: ARN da Policy 1
    Value: !Ref Policy1
    Export:
      Name: !Sub "${ClusterName}-AmazonEKSAdminPolicy"

  Policy2Arn:
    Description: ARN da Policy 2
    Value: !Ref Policy2
    Export:
      Name: !Sub "${ClusterName}-eks-admin-policy"

  Policy3Arn:
    Description: ARN da Policy 3
    Value: !Ref Policy3
    Export:
      Name: !Sub "${ClusterName}-KUBERNETES-NODES-WAFv2"

  Policy4Arn:
    Description: ARN da Policy 4
    Value: !Ref Policy4
    Export:
      Name: !Sub "${ClusterName}-KUBERNETES-NODES-S3"

  Policy5Arn:
    Description: ARN da Policy 5
    Value: !Ref Policy5
    Export:
      Name: !Sub "${ClusterName}-KUBERNETES-REKOGNITION-COGNITO"

  Policy6Arn:
    Description: ARN da Policy 6
    Value: !Ref Policy6
    Export:
      Name: !Sub "${ClusterName}-SQS-SSM-SES-KMS-DYNAMO-SNS-SECRETS"

      